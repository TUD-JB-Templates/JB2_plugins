name: Deploy Multi-Language MyST Books üåç

on:
  push:
    branches:
      - "**"        # run on pushes to any branch
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PRIMARY_BRANCH: main
  BEHAVIOR_PRIMARY: copy   # ‚úÖ serve English at / and /en/
  NODE_VERSION: "18"

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # 1Ô∏è‚É£ Discover remote branches (main + language-*)
  get-branches:
    runs-on: ubuntu-latest
    outputs:
      branches: ${{ steps.list.outputs.branches }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List remote branches (main + language-*)
        id: list
        shell: bash
        run: |
          git fetch --all --prune

          # Only include main and branches that start with language-
          branches=$(git for-each-ref refs/remotes/origin --format='%(refname:short)' \
            | sed 's|^origin/||' \
            | grep -E '^(main|language-)' \
            | sort -u)

          echo "Found branches:"
          echo "$branches" | sed 's/^/ - /'

          # Convert to JSON array
          json=$(printf '%s\n' "$branches" | jq -R . | jq -s -c .)
          echo "branches=$json" >> "$GITHUB_OUTPUT"

  # 2Ô∏è‚É£ Build each branch
  build:
    needs: get-branches
    if: ${{ needs.get-branches.outputs.branches != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        branch: ${{ fromJson(needs.get-branches.outputs.branches) }}

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
          fetch-depth: 0
          submodules: true

      - name: Determine publish folder
        id: map
        shell: bash
        run: |
          BRANCH="${{ matrix.branch }}"

          if [ "$BRANCH" = "main" ]; then
            FOLDER="en"
          elif [[ "$BRANCH" =~ ^language-([A-Za-z0-9-]+)$ ]]; then
            FOLDER="${BASH_REMATCH[1]}"
          else
            FOLDER="$(echo "$BRANCH" | tr '/\":<>|*?\\' '-' )"
          fi

          echo "Branch: $BRANCH"
          echo "Folder: $FOLDER"
          echo "folder=$FOLDER" >> $GITHUB_OUTPUT
          echo "BASE_URL=/${{ github.event.repository.name }}/${FOLDER}" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install MyST Markdown CLI
        run: npm install -g mystmd

      - name: Build MyST Book (HTML)
        env:
          BASE_URL: ${{ env.BASE_URL }}
        run: |
          echo "Building for folder: ${{ steps.map.outputs.folder }}"
          echo "Using BASE_URL: $BASE_URL"
          myst build --html
          test -f _build/html/index.html || (echo "‚ùå No _build/html/index.html produced" && exit 1)

      - name: Upload artifact for this branch
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.map.outputs.folder }}
          path: _build/html

  # 3Ô∏è‚É£ Combine builds and deploy
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Prepare site folder
        run: |
          mkdir -p final site

      - name: Download all built artifacts
        uses: actions/download-artifact@v4
        with:
          path: final

      - name: Organize folders (languages)
        id: organize
        shell: bash
        run: |
          BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "## üåç Published Folders" >> $GITHUB_STEP_SUMMARY
          echo "| Folder | Source Branch | Public URL |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------------|------------|" >> $GITHUB_STEP_SUMMARY

          shopt -s nullglob
          for dir in final/*; do
            [ -d "$dir" ] || continue
            folder="$(basename "$dir")"
            mkdir -p "site/${folder}"
            cp -r "${dir}/." "site/${folder}/"
            echo "| ${folder} | (see artifact name) | ${BASE_URL}/${folder}/ |" >> $GITHUB_STEP_SUMMARY
          done

          touch site/.nojekyll

          if [ ! -d site/en ]; then
            echo "‚ùå No English folder found (site/en missing)." >&2
            exit 1
          fi

      - name: Root behavior (copy English to /)
        shell: bash
        run: |
          cd site
          echo "Copying English version to root..."
          cp -r en/* .
          cd ..

      - name: Upload Pages artifact (complete site)
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "Repository: **${{ github.repository }}**" >> $GITHUB_STEP_SUMMARY
          echo "Root: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üß≠ Behavior"
          echo "- PRIMARY_BRANCH: \`${{ env.PRIMARY_BRANCH }}\` (English)" >> $GITHUB_STEP_SUMMARY
          echo "- BEHAVIOR_PRIMARY: \`${{ env.BEHAVIOR_PRIMARY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó URLs"
          echo "- English ‚Üí [${{ steps.deployment.outputs.page_url }}en/]" >> $GITHUB_STEP_SUMMARY
          echo "- Root    ‚Üí [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- Dutch   ‚Üí [${{ steps.deployment.outputs.page_url }}nl/] (if \`language-nl\` exists)" >> $GITHUB_STEP_SUMMARY
