name: Deploy Multi-Language MyST Books

on:
  push:
    branches:
      - main
      - language-*
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PRIMARY_BRANCH: main
  BEHAVIOR_PRIMARY: redirect  # or copy / move
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # 1Ô∏è‚É£ Detect branches and deploy each book
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Detect language code
        id: lang
        run: |
          branch="${GITHUB_REF_NAME}"
          if [[ "$branch" == "main" ]]; then
            lang="en"
          elif [[ "$branch" =~ ^language-([a-z]+)$ ]]; then
            lang="${BASH_REMATCH[1]}"
          else
            lang="$branch"
          fi
          echo "üìò Branch: $branch"
          echo "üåê Language code: $lang"
          echo "lang=$lang" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install mystmd

      - name: Build MyST book
        run: |
          myst build --html
          ls -R _build/html || echo "‚ö†Ô∏è No HTML output found"

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.lang.outputs.lang }}
          path: _build/html

  # 2Ô∏è‚É£ Collect and deploy all language builds
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout gh-pages branch (or create it)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: gh-pages

      - name: Prepare deployment folder
        run: |
          mkdir -p final
          echo "Preparing final deployment structure..."

      - name: Download all language artifacts
        uses: actions/download-artifact@v4
        with:
          path: final

      - name: Move each artifact into language folder
        run: |
          cd final
          for dir in */; do
            lang="${dir%/}"
            mkdir -p "../site/${lang}"
            cp -r "${dir}/." "../site/${lang}/"
          done
          cd ..

      - name: Handle primary branch behavior
        run: |
          cd site
          if [ "${PRIMARY_BRANCH}" = "main" ] && [ "${BEHAVIOR_PRIMARY}" = "redirect" ]; then
            echo '<meta http-equiv="refresh" content="0; url=en/">' > index.html
            echo "üåç Root will redirect to /en/"
          elif [ "${BEHAVIOR_PRIMARY}" = "copy" ]; then
            cp -r en/* .
            echo "üåç Root will copy /en/"
          elif [ "${BEHAVIOR_PRIMARY}" = "move" ]; then
            mv en/* .
            rm -rf en
            echo "üåç Root will move /en/"
          fi
          cd ..

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
