name: Build & Deploy MyST (multi-language fixed detection)

on:
  push:
    branches:
      - main
      - language-*
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: Setup Typst
        uses: typst-community/setup-typst@v4

      - name: Install MyST
        run: npm install -g mystmd

      # --- detect language robustly ---
      - name: Detect language branch
        id: compute
        shell: bash
        run: |
          echo "🔍 Raw GitHub vars:"
          echo "GITHUB_REF: ${GITHUB_REF}"
          echo "GITHUB_REF_NAME: ${GITHUB_REF_NAME}"
          echo "GITHUB_HEAD_REF: ${GITHUB_HEAD_REF}"

          BRANCH="${GITHUB_REF_NAME:-${GITHUB_HEAD_REF}}"
          if [ -z "$BRANCH" ]; then
            BRANCH="$(echo "${GITHUB_REF}" | sed 's|refs/heads/||')"
          fi

          echo "📘 Detected raw branch name: $BRANCH"

          if [ "$BRANCH" = "main" ]; then
            LANG_CODE="en"
          elif [[ "$BRANCH" =~ ^language[-_/](.+)$ ]]; then
            LANG_CODE="${BASH_REMATCH[1]}"
          else
            echo "❌ Branch '$BRANCH' not configured for deployment."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ Detected language code: ${LANG_CODE}"
          echo "lang_code=${LANG_CODE}" >> $GITHUB_OUTPUT
          echo "BASE_URL=/${{ github.event.repository.name }}/${LANG_CODE}" >> $GITHUB_ENV
          echo "deployed_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${LANG_CODE}/" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT